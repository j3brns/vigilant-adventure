# -----------------------------------------------------------------------------
# AgentCore Agent - GitLab CI Pipeline (Strands Agents SDK)
# -----------------------------------------------------------------------------
# This pipeline handles the application track of the two-track release model.
# Agents are built using the Strands Agents SDK and deployed to AgentCore Runtime.
#
# Pipeline stages:
#   1. validate  - Lint, type check, security scan
#   2. test      - Unit and integration tests
#   3. build     - Package agent for deployment
#   4. deploy    - Deploy to AgentCore Runtime
#
# Required CI/CD Variables (set by Terraform during tenant provisioning):
#   - TENANT_ID                   : Tenant identifier
#   - TENANT_EXECUTION_ROLE_ARN   : IAM role for agent execution
#   - ENVIRONMENT                 : Target environment (dev/prod)
#
# Required CI/CD Variables (set manually or via GitLab group):
#   - AWS_REGION                  : AWS region (default: eu-west-2)
# -----------------------------------------------------------------------------

stages:
  - validate
  - test
  - build
  - deploy

variables:
  PYTHON_VERSION: "3.11"
  AWS_REGION: "eu-west-2"
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.pip-cache"

# -----------------------------------------------------------------------------
# Templates
# -----------------------------------------------------------------------------

.python_base:
  image: python:${PYTHON_VERSION}-slim
  before_script:
    - pip install --upgrade pip
    - pip install -r requirements.txt -r requirements-dev.txt
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - .pip-cache/
      - .venv/

.aws_base:
  image: amazon/aws-cli:latest
  id_tokens:
    GITLAB_OIDC_TOKEN:
      aud: https://gitlab.com
  before_script:
    - >
      export $(printf "AWS_ACCESS_KEY_ID=%s AWS_SECRET_ACCESS_KEY=%s AWS_SESSION_TOKEN=%s"
      $(aws sts assume-role-with-web-identity
      --role-arn ${TENANT_EXECUTION_ROLE_ARN}
      --role-session-name "gitlab-${CI_PROJECT_ID}-${CI_PIPELINE_ID}"
      --web-identity-token ${GITLAB_OIDC_TOKEN}
      --duration-seconds 3600
      --query 'Credentials.[AccessKeyId,SecretAccessKey,SessionToken]'
      --output text))
    - aws sts get-caller-identity

# -----------------------------------------------------------------------------
# Validate Stage
# -----------------------------------------------------------------------------

lint:
  stage: validate
  extends: .python_base
  script:
    - echo "Running linters..."
    - ruff check src/ tests/
    - ruff format --check src/ tests/
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

type-check:
  stage: validate
  extends: .python_base
  script:
    - echo "Running type checker..."
    - mypy src/ --ignore-missing-imports
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

security-scan:
  stage: validate
  extends: .python_base
  script:
    - echo "Running security scan..."
    - pip install bandit safety
    - bandit -r src/ -ll
    - safety check -r requirements.txt
  allow_failure: true
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

# -----------------------------------------------------------------------------
# Test Stage
# -----------------------------------------------------------------------------

unit-tests:
  stage: test
  extends: .python_base
  script:
    - echo "Running unit tests..."
    - pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=term
  coverage: '/TOTAL.*\s+(\d+%)/'
  artifacts:
    reports:
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
    expire_in: 1 week
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH

integration-tests:
  stage: test
  extends: .python_base
  variables:
    RUN_INTEGRATION_TESTS: "1"
  script:
    - echo "Running integration tests..."
    - pytest tests/integration/ -v --timeout=120
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - unit-tests

# -----------------------------------------------------------------------------
# Build Stage
# -----------------------------------------------------------------------------

build-agent:
  stage: build
  extends: .python_base
  script:
    - echo "Building agent package..."
    - |
      # Create deployment package
      mkdir -p dist
      
      # Copy source code
      cp -r src/* dist/
      cp -r config dist/
      
      # Install production dependencies into package
      pip install -r requirements.txt -t dist/ --upgrade
      
      # Create version file
      cat > dist/version.json << EOF
      {
        "version": "${CI_COMMIT_SHORT_SHA}",
        "tenant_id": "${TENANT_ID}",
        "built_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
        "git_ref": "${CI_COMMIT_REF_NAME}"
      }
      EOF
      
      # Package
      cd dist && zip -r ../agent-${CI_COMMIT_SHORT_SHA}.zip . -x "*.pyc" -x "__pycache__/*"
  artifacts:
    paths:
      - agent-${CI_COMMIT_SHORT_SHA}.zip
    expire_in: 1 week
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  needs:
    - unit-tests
    - lint

# -----------------------------------------------------------------------------
# Deploy Stage
# -----------------------------------------------------------------------------

.deploy_base:
  stage: deploy
  extends: .aws_base
  script:
    - yum install -y jq
    - echo "Deploying agent for tenant ${TENANT_ID} to ${DEPLOY_ENVIRONMENT}..."
    - |
      # Upload agent package to S3
      BUCKET="agentcore-agents-${DEPLOY_ENVIRONMENT}"
      KEY="tenants/${TENANT_ID}/agent-${CI_COMMIT_SHORT_SHA}.zip"
      
      aws s3 cp agent-${CI_COMMIT_SHORT_SHA}.zip "s3://${BUCKET}/${KEY}"
      
      # Update agent registry in DynamoDB
      aws dynamodb update-item \
        --table-name "agentcore-runtime-registry-${DEPLOY_ENVIRONMENT}" \
        --key "{\"agent_id\": {\"S\": \"${TENANT_ID}-agent\"}}" \
        --update-expression "SET version = :v, package_key = :k, deployed_at = :d, deployed_by = :u, #s = :st" \
        --expression-attribute-names '{"#s": "status"}' \
        --expression-attribute-values "{
          \":v\": {\"S\": \"${CI_COMMIT_SHORT_SHA}\"},
          \":k\": {\"S\": \"${KEY}\"},
          \":d\": {\"S\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"},
          \":u\": {\"S\": \"${GITLAB_USER_LOGIN}\"},
          \":st\": {\"S\": \"deployed\"}
        }"
      
      echo "Agent deployed successfully. Version: ${CI_COMMIT_SHORT_SHA}"
  needs:
    - build-agent

deploy-dev:
  extends: .deploy_base
  variables:
    DEPLOY_ENVIRONMENT: "dev"
  environment:
    name: development
    url: https://agentcore-dev.${AWS_REGION}.amazonaws.com/tenants/${TENANT_ID}
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual

deploy-prod:
  extends: .deploy_base
  variables:
    DEPLOY_ENVIRONMENT: "prod"
  environment:
    name: production
    url: https://agentcore.${AWS_REGION}.amazonaws.com/tenants/${TENANT_ID}
  rules:
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
      when: manual
  needs:
    - deploy-dev
